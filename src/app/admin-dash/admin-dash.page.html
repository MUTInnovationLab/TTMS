<ion-header [translucent]="true" class="app-header">
  <ion-toolbar>
    <div class="header-content">
      <div class="logo-container">
        <img src="assets/logo.png" alt="TTMS Logo" class="logo" style="height: 50px; width: auto;">
        <ion-title>Timetable Management System</ion-title>
      </div>

      <div class="header-actions">
        <ion-button fill="clear" class="notification-btn">
          <ion-badge *ngIf="notificationCount > 0" color="danger">{{notificationCount}}</ion-badge>
          <ion-icon name="notifications-outline" slot="icon-only"></ion-icon>
        </ion-button>

        <ion-button fill="clear" class="profile-btn" (click)="toggleProfileMenu()">
          <ion-avatar slot="start">
            <img src="assets/avatar.png" alt="User Avatar">
          </ion-avatar>
          <ion-icon name="chevron-down-outline"></ion-icon>
        </ion-button>

        <div class="profile-dropdown" *ngIf="showProfileMenu">
          <ion-list lines="none">
            <ion-item button (click)="navigateToSettings()">
              <ion-icon name="settings-outline" slot="start"></ion-icon>
              <ion-label>Settings</ion-label>
            </ion-item>
            <ion-item button (click)="logout()">
              <ion-icon name="log-out-outline" slot="start"></ion-icon>
              <ion-label>Logout</ion-label>
            </ion-item>
          </ion-list>
        </div>
      </div>
    </div>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <div class="dashboard-container">
    <!-- Navigation Sidebar -->
    <div class="sidebar" [class.visible]="sidebarVisible">
      <ion-list>
        <ion-item button [class.active]="activeSection === 'dashboard'" (click)="changeSection('dashboard')">
          <ion-icon name="grid-outline" slot="start"></ion-icon>
          <ion-label>Dashboard</ion-label>
        </ion-item>

        <ion-item button [class.active]="activeSection === 'timetable'" (click)="changeSection('timetable')">
          <ion-icon name="calendar-outline" slot="start"></ion-icon>
          <ion-label>Timetable Management</ion-label>
        </ion-item>

        <ion-item button [class.active]="activeSection === 'calendar'" (click)="changeSection('calendar')">
          <ion-icon name="cloud-upload-outline" slot="start"></ion-icon>
          <ion-label>Calendar Configuration</ion-label>
        </ion-item>

        <ion-item button [class.active]="activeSection === 'departments'" (click)="changeSection('departments')">
          <ion-icon name="business-outline" slot="start"></ion-icon>
          <ion-label>Department Management</ion-label>
        </ion-item>

        <ion-item button [class.active]="activeSection === 'users'" (click)="changeSection('users')">
          <ion-icon name="people-outline" slot="start"></ion-icon>
          <ion-label>User Management</ion-label>
        </ion-item>

        <ion-item button [class.active]="activeSection === 'venues'" (click)="changeSection('venues')">
          <ion-icon name="business-outline" slot="start"></ion-icon>
          <ion-label>Venue Management</ion-label>
        </ion-item>

        <ion-item button [class.active]="activeSection === 'reports'" (click)="changeSection('reports')">
          <ion-icon name="bar-chart-outline" slot="start"></ion-icon>
          <ion-label>Reports</ion-label>
        </ion-item>

        <ion-item button [class.active]="activeSection === 'settings'" (click)="changeSection('settings')">
          <ion-icon name="settings-outline" slot="start"></ion-icon>
          <ion-label>System Settings</ion-label>
        </ion-item>

        <ion-item button [class.active]="activeSection === 'backup'" (click)="changeSection('backup')">
          <ion-icon name="save-outline" slot="start"></ion-icon>
          <ion-label>Backup & Restore</ion-label>
        </ion-item>


            <ion-item button (click)="logout()">
            <ion-icon name="log-out-outline" slot="start"></ion-icon>
            <ion-label>Logout</ion-label>
            </ion-item>
      </ion-list>
    </div>

    <!-- Sidebar backdrop for mobile -->
    <div class="sidebar-backdrop" [class.visible]="sidebarVisible" (click)="toggleSidebar()"></div>

    <ion-button class="sidebar-toggle" [class.sidebar-visible]="sidebarVisible" (click)="toggleSidebar()">
      <ion-icon [name]="sidebarVisible ? 'chevron-back' : 'menu'"></ion-icon>
    </ion-button>

    <!-- Main Content Area -->
    <div class="main-content" [class.sidebar-visible]="sidebarVisible">
      <!-- Dashboard Section -->
      <div *ngIf="activeSection === 'dashboard'" class="section-container">
        <div class="dashboard-header">
          <h1>Dashboard Overview</h1>
          <div class="dashboard-actions">
            <ion-button fill="outline" size="small" (click)="refreshRealTimeData()">
              <ion-icon name="refresh" slot="start"></ion-icon>
              Refresh
            </ion-button>
            <div class="last-updated">
              Last updated: {{ stats.lastUpdated | date:'short' }}
            </div>
          </div>
        </div>

        <!-- Enhanced Stats Grid with Real-time Data -->
        <div class="stats-grid">
          <div class="stat-card">
            <ion-icon name="business"></ion-icon>
            <h2>{{stats.departments}}</h2>
            <p>Departments</p>
          </div>

          <div class="stat-card">
            <ion-icon name="business"></ion-icon>
            <h2>{{stats.venues}}</h2>
            <p>Venues</p>
          </div>

          <div class="stat-card">
            <ion-icon name="calendar"></ion-icon>
            <h2>{{stats.sessions}}</h2>
            <p>Scheduled Sessions</p>
          </div>

          <div class="stat-card">
            <ion-icon name="document-text"></ion-icon>
            <h2>{{stats.submissions}}</h2>
            <p>Total Submissions</p>
          </div>

          <div class="stat-card pending">
            <ion-icon name="time"></ion-icon>
            <h2>{{stats.pendingSubmissions}}</h2>
            <p>Pending Review</p>
          </div>

          <div class="stat-card success">
            <ion-icon name="checkmark-circle"></ion-icon>
            <h2>{{stats.approvedSubmissions}}</h2>
            <p>Approved</p>
          </div>

          <div class="stat-card alert">
            <ion-icon name="warning"></ion-icon>
            <h2>{{stats.conflicts}}</h2>
            <p>Active Conflicts</p>
          </div>

          <div class="stat-card primary">
            <ion-icon name="people"></ion-icon>
            <h2>{{stats.activeUsers}}</h2>
            <p>Active Users (30d)</p>
          </div>
        </div>

        <!-- Department Submission Status Dashboard -->
        <div class="department-status-section">
          <div class="section-header">
            <h3>Department Submission Status</h3>
            <div class="submission-stats">
              <ion-chip color="success">
                <ion-label>{{ getSubmissionRate() }}% Completion Rate</ion-label>
              </ion-chip>
            </div>
          </div>

          <div class="department-status-grid">
            <ion-card 
              *ngFor="let dept of departmentSubmissionStatuses" 
              class="department-card"
              [class]="getDepartmentStatusColor(dept.status)"
              (click)="viewDepartmentDetails(dept)">
              
              <ion-card-header>
                <div class="department-header">
                  <div class="department-info">
                    <ion-card-title>{{ dept.departmentName }}</ion-card-title>
                    <ion-card-subtitle *ngIf="dept.hodName">
                      HOD: {{ dept.hodName }}
                    </ion-card-subtitle>
                  </div>
                  <div class="department-status">
                    <ion-chip [color]="getDepartmentStatusColor(dept.status)">
                      <ion-icon [name]="getDepartmentStatusIcon(dept.status)"></ion-icon>
                      <ion-label>{{ getDepartmentStatusLabel(dept.status) }}</ion-label>
                    </ion-chip>
                  </div>
                </div>
              </ion-card-header>

              <ion-card-content>
                <div class="department-progress">
                  <div class="progress-header">
                    <span>Timetable Progress</span>
                    <span>{{ dept.progress }}%</span>
                  </div>
                  <div class="progress-bar">
                    <div class="progress-fill" [style.width.%]="dept.progress"></div>
                  </div>
                </div>

                <div class="department-stats">
                  <div class="stat-item">
                    <ion-icon name="calendar-outline"></ion-icon>
                    <span>{{ dept.sessionsCount }} Sessions</span>
                  </div>
                  <div class="stat-item" *ngIf="dept.conflictsCount > 0">
                    <ion-icon name="warning-outline" color="danger"></ion-icon>
                    <span>{{ dept.conflictsCount }} Conflicts</span>
                  </div>
                  <div class="stat-item" *ngIf="dept.conflictsCount === 0 && dept.sessionsCount > 0">
                    <ion-icon name="checkmark-circle-outline" color="success"></ion-icon>
                    <span>No Conflicts</span>
                  </div>
                  <div class="stat-item">
                    <ion-icon name="people-outline"></ion-icon>
                    <span>{{ getDepartmentLecturerCount(dept.departmentName) }} Lecturers</span>
                  </div>
                  <div class="stat-item">
                    <ion-icon name="library-outline"></ion-icon>
                    <span>{{ getDepartmentModuleCount(dept.departmentName) }} Modules</span>
                  </div>
                  <div class="stat-item">
                    <ion-icon name="business-outline"></ion-icon>
                    <span>{{ getDepartmentVenueUsage(dept.departmentName) }} Venues Used</span>
                  </div>
                  <div class="stat-item">
                    <ion-icon name="time-outline"></ion-icon>
                    <span>{{ formatLastModified(dept.lastModified) }}</span>
                  </div>
                </div>

                <div class="department-workload" *ngIf="dept.sessionsCount > 0">
                  <div class="workload-header">
                    <span>Weekly Teaching Hours</span>
                    <span>{{ getDepartmentTotalHours(dept.departmentName) }}h</span>
                  </div>
                  <div class="workload-breakdown">
                    <ion-chip size="small" color="primary" *ngIf="getDepartmentLectureHours(dept.departmentName) > 0">
                      <ion-label>{{ getDepartmentLectureHours(dept.departmentName) }}h Lectures</ion-label>
                    </ion-chip>
                    <ion-chip size="small" color="secondary" *ngIf="getDepartmentLabHours(dept.departmentName) > 0">
                      <ion-label>{{ getDepartmentLabHours(dept.departmentName) }}h Practicals</ion-label>
                    </ion-chip>
                    <ion-chip size="small" color="tertiary" *ngIf="getDepartmentTutorialHours(dept.departmentName) > 0">
                      <ion-label>{{ getDepartmentTutorialHours(dept.departmentName) }}h Tutorials</ion-label>
                    </ion-chip>
                  </div>
                </div>

                <div class="department-actions" *ngIf="dept.status !== 'approved'">
                  <ion-button 
                    size="small" 
                    fill="outline" 
                    *ngIf="dept.status === 'not-started' || dept.status === 'in-progress'"
                    (click)="promptDepartmentSubmission(dept); $event.stopPropagation()">
                    <ion-icon name="paper-plane" slot="start"></ion-icon>
                    Remind
                  </ion-button>
                  
                  <ion-button 
                    size="small" 
                    color="success" 
                    fill="outline"
                    *ngIf="dept.status === 'submitted'"
                    (click)="changeSection('timetable'); $event.stopPropagation()">
                    <ion-icon name="checkmark" slot="start"></ion-icon>
                    Review
                  </ion-button>
                </div>

                <div class="feedback-section" *ngIf="dept.feedback && dept.status === 'rejected'">
                  <p class="feedback-text">{{ dept.feedback }}</p>
                </div>
              </ion-card-content>
            </ion-card>
          </div>

          <!-- Departments Needing Attention -->
          <div class="attention-section" *ngIf="getDepartmentsNeedingAttention().length > 0">
            <h4>
              <ion-icon name="warning" color="danger"></ion-icon>
              Departments Needing Attention
            </h4>
            <ion-list>
              <ion-item *ngFor="let dept of getDepartmentsNeedingAttention()">
                <ion-avatar slot="start">
                  <ion-icon [name]="getDepartmentStatusIcon(dept.status)"></ion-icon>
                </ion-avatar>
                <ion-label>
                  <h3>{{ dept.departmentName }}</h3>
                  <p *ngIf="dept.status === 'rejected'">Submission rejected</p>
                  <p *ngIf="dept.conflictsCount > 0">{{ dept.conflictsCount }} unresolved conflicts</p>
                </ion-label>
                <ion-button slot="end" fill="outline" size="small" (click)="viewDepartmentDetails(dept)">
                  View Details
                </ion-button>
              </ion-item>
            </ion-list>
          </div>
        </div>

        <div class="dashboard-charts">
          <div class="chart-container">
            <h3>Department Submission Status</h3>
            <!-- Chart placeholder -->
            <div class="chart-placeholder"></div>
          </div>

          <div class="activities-container">
            <h3>Recent Activities</h3>
            <div class="timeline">
              <div class="timeline-item" *ngFor="let activity of recentActivities">
                <div class="timeline-icon" [ngClass]="activity.type">
                  <ion-icon [name]="activity.icon"></ion-icon>
                </div>
                <div class="timeline-content">
                  <p class="activity">{{activity.message}}</p>
                  <p class="timestamp">{{activity.timestamp | date:'medium'}}</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="quick-actions">
          <h3>Quick Actions</h3>
          <div class="actions-grid">
            <ion-button expand="block" (click)="changeSection('timetable')">
              <ion-icon name="calendar" slot="start"></ion-icon>
              Manage Timetables
            </ion-button>

            <ion-button expand="block" (click)="createNewTimetable()">
              <ion-icon name="add-circle" slot="start"></ion-icon>
              New Timetable
            </ion-button>

            <ion-button expand="block" (click)="publishTimetable()">
              <ion-icon name="cloud-upload" slot="start"></ion-icon>
              Publish Timetable
            </ion-button>

            <ion-button expand="block" (click)="resolveConflicts()">
              <ion-icon name="alert-circle" slot="start"></ion-icon>
              Resolve Conflicts
            </ion-button>
          </div>
        </div>
      </div>

      <!-- Timetable Management Section -->
      <div *ngIf="activeSection === 'timetable'" class="section-container">
        <h1>Timetable Management</h1>

        <ion-segment [(ngModel)]="timetableView" (ionChange)="timetableViewChanged()">
          <ion-segment-button value="master">
            <ion-label>Master Timetable</ion-label>
          </ion-segment-button>
          <ion-segment-button value="submissions">
            <ion-label>Department Submissions</ion-label>
          </ion-segment-button>
          <ion-segment-button value="conflicts">
            <ion-label>Conflicts</ion-label>
          </ion-segment-button>
          <ion-segment-button value="publication">
            <ion-label>Publication</ion-label>
          </ion-segment-button>
        </ion-segment>

        <div class="timetable-content">
          <!-- Replace placeholder with timetable-grid component -->
          <div *ngIf="timetableView === 'master'">
            <app-timetable-grid [sessions]="masterTimetableSessions" (sessionClick)="handleSessionClick($event)"
              (sessionDrop)="handleMasterTimetableSessionDrop($event)">
            </app-timetable-grid>
          </div>

          <div *ngIf="timetableView === 'submissions'">
            <!-- Loading indicator -->
            <ion-card *ngIf="submissionsLoading" class="loading-card">
              <ion-card-content>
                <ion-spinner name="crescent"></ion-spinner>
                <p>Loading submitted timetables...</p>
              </ion-card-content>
            </ion-card>

            <!-- Submitted Timetables List -->
            <div *ngIf="!submissionsLoading && submittedTimetables.length > 0" class="submissions-list">
              <ion-card *ngFor="let timetable of submittedTimetables" class="submission-card"
                [class.selected]="selectedSubmittedTimetable?.id === timetable.id">
                <ion-card-header>
                  <div class="submission-header">
                    <div class="submission-info">
                      <ion-card-title>{{ timetable.department }}</ion-card-title>
                      <ion-card-subtitle>
                        {{ timetable.academicYear }}, Semester {{ timetable.semester }}
                      </ion-card-subtitle>
                    </div>
                    <div class="submission-status">
                      <ion-chip [color]="getTimetableStatusColor(timetable.status)">
                        <ion-icon [name]="getTimetableStatusIcon(timetable.status)"></ion-icon>
                        <ion-label>{{ timetable.status | titlecase }}</ion-label>
                      </ion-chip>
                    </div>
                  </div>
                </ion-card-header>
                
                <ion-card-content>
                  <div class="submission-details">
                    <p><strong>HOD:</strong> {{ timetable.hodEmail }}</p>
                    <p><strong>Sessions:</strong> {{ timetable.sessions?.length || 0 }}</p>
                    <p><strong>Status:</strong> {{ timetable.status | titlecase }}</p>
                    <p><strong>Submitted:</strong> {{ formatDate(timetable.submittedAt) }}</p>
                    <div *ngIf="timetable.adminFeedback" class="admin-feedback">
                      <p><strong>Admin Feedback:</strong></p>
                      <p class="feedback-text">{{ timetable.adminFeedback }}</p>
                    </div>
                  </div>
                  
                  <div class="submission-actions">
                    <ion-button fill="outline" size="small" 
                      (click)="selectTimetableForReview(timetable)">
                      <ion-icon name="eye-outline" slot="start"></ion-icon>
                      View Details
                    </ion-button>
                    
                    <div *ngIf="timetable.status === 'submitted' || timetable.status === 'pending'" class="approval-actions">
                      <ion-button color="success" size="small" 
                        [disabled]="isSubmitting"
                        (click)="selectAndApprove(timetable)">
                        <ion-icon name="checkmark-circle" slot="start"></ion-icon>
                        Approve
                      </ion-button>
                      
                      <ion-button color="danger" size="small" 
                        [disabled]="isSubmitting"
                        (click)="selectAndReject(timetable)">
                        <ion-icon name="close-circle" slot="start"></ion-icon>
                        Reject
                      </ion-button>
                    </div>
                  </div>
                </ion-card-content>
              </ion-card>
            </div>

            <!-- Selected Timetable Details -->
            <div *ngIf="selectedSubmittedTimetable && !submissionsLoading" class="selected-submission-details">
              <ion-card class="selected-timetable-card">
                <ion-card-header>
                  <div class="selected-header">
                    <ion-card-title>
                      Reviewing: {{ selectedSubmittedTimetable.department }} Timetable
                    </ion-card-title>
                    <ion-button fill="clear" (click)="clearSelection()">
                      <ion-icon name="close-outline"></ion-icon>
                    </ion-button>
                  </div>
                </ion-card-header>
                
                <ion-card-content>
                  <!-- Conflict warning alert if conflicts are detected -->
                  <ion-card *ngIf="departmentSubmissionConflicts.length > 0" color="warning" class="submission-conflict-alert">
                    <ion-card-header>
                      <ion-card-title>
                        <ion-icon name="warning-outline"></ion-icon>
                        Conflicts Detected in Submission
                      </ion-card-title>
                      <ion-card-subtitle>
                        {{ departmentSubmissionConflicts.length }} conflicts need to be resolved before approval
                      </ion-card-subtitle>
                    </ion-card-header>
                    <ion-card-content>
                      <ion-button expand="block" (click)="showDepartmentSubmissionConflicts()">
                        <ion-icon name="construct-outline" slot="start"></ion-icon>
                        Resolve Conflicts
                      </ion-button>
                    </ion-card-content>
                  </ion-card>

                  <!-- Action buttons for submitted or pending timetables -->
                  <div *ngIf="selectedSubmittedTimetable.status === 'submitted' || selectedSubmittedTimetable.status === 'pending'" class="action-buttons">
                    <ion-button color="success" 
                      [disabled]="departmentSubmissionConflicts.length > 0 || isSubmitting" 
                      (click)="approveDepartmentSubmission()">
                      <ion-icon name="checkmark-circle" slot="start"></ion-icon>
                      <ion-spinner *ngIf="isSubmitting" name="crescent" slot="start"></ion-spinner>
                      Approve Submission
                    </ion-button>
                    
                    <ion-button color="danger" 
                      [disabled]="isSubmitting" 
                      (click)="rejectDepartmentSubmission()">
                      <ion-icon name="close-circle" slot="start"></ion-icon>
                      Request Changes
                    </ion-button>
                  </div>

                  <!-- Timetable view toggle -->
                  <div class="view-toggle">
                    <ion-segment [(ngModel)]="showingDeptConflictRes" (ionChange)="onViewToggle()">
                      <ion-segment-button [value]="false">
                        <ion-label>Timetable Grid</ion-label>
                      </ion-segment-button>
                      <ion-segment-button [value]="true" [disabled]="departmentSubmissionConflicts.length === 0">
                        <ion-label>Conflict Resolution</ion-label>
                      </ion-segment-button>
                    </ion-segment>
                  </div>

                  <!-- Timetable Grid View -->
                  <div *ngIf="!showingDeptConflictRes" class="timetable-view">
                    <app-timetable-grid [sessions]="departmentSubmissionSessions" (sessionClick)="handleSessionClick($event)">
                    </app-timetable-grid>
                  </div>

                  <!-- Conflict Resolution View -->
                  <div *ngIf="showingDeptConflictRes" class="conflict-resolution-view">
                    <app-conflict-res [conflicts]="departmentSubmissionConflicts"
                      (resolveConflict)="handleDepartmentConflictResolution($event)">
                    </app-conflict-res>
                  </div>
                </ion-card-content>
              </ion-card>
            </div>

            <!-- No submissions message -->
            <div *ngIf="!submissionsLoading && submittedTimetables.length === 0" class="no-submissions">
              <ion-card>
                <ion-card-content class="text-center">
                  <ion-icon name="document-outline" size="large" color="medium"></ion-icon>
                  <h3>No Submitted Timetables</h3>
                  <p>There are currently no timetable submissions from departments.</p>
                  
                  <!-- Temporary test button -->
                  <ion-button fill="outline" (click)="createTestTimetableSubmission()">
                    <ion-icon name="add-outline" slot="start"></ion-icon>
                    Create Test Submission
                  </ion-button>
                </ion-card-content>
              </ion-card>
            </div>
          </div>

          <div *ngIf="timetableView === 'conflicts'">
            <!-- Replace conflict summary and timetable with conflict resolution component -->
            <div class="conflict-resolution-wrapper">
              <app-conflict-res [conflicts]="formattedConflicts" (resolveConflict)="handleConflictResolution($event)">
              </app-conflict-res>
            </div>

            <!-- Show this only when there are no conflicts -->
            <div *ngIf="conflictSummary.length === 0" class="placeholder-content success-content">
              <ion-icon name="checkmark-circle" color="success" style="font-size: 48px;"></ion-icon>
              <p>No conflicts detected in the current timetable</p>
            </div>
          </div>

          <div *ngIf="timetableView === 'publication'">
            <div class="publication-controls">
              <ion-card>
                <ion-card-header>
                  <ion-card-title>Timetable Publication</ion-card-title>
                  <ion-card-subtitle>Publish the master timetable for viewing by all users</ion-card-subtitle>
                </ion-card-header>
                <ion-card-content>
                  <ion-item>
                    <ion-label position="stacked">Publication Title</ion-label>
                    <ion-input [(ngModel)]="publicationTitle"
                      placeholder="e.g., Semester 1 2023-2024 Timetable"></ion-input>
                  </ion-item>
                  <ion-item>
                    <ion-label position="stacked">Publication Notes</ion-label>
                    <ion-textarea [(ngModel)]="publicationNotes"
                      placeholder="Any special notes or announcements..."></ion-textarea>
                  </ion-item>
                  <ion-item>
                    <ion-label>Notify All Users</ion-label>
                    <ion-toggle [(ngModel)]="notifyUsers"></ion-toggle>
                  </ion-item>
                  <ion-button expand="block" color="primary" (click)="publishFinalTimetable()"
                    [disabled]="conflictSessions.length > 0">
                    <ion-icon name="cloud-upload" slot="start"></ion-icon>
                    Publish Timetable
                  </ion-button>
                  <p *ngIf="conflictSessions.length > 0" class="error-message">
                    <ion-icon name="alert-circle"></ion-icon>
                    Cannot publish timetable with unresolved conflicts
                  </p>
                </ion-card-content>
              </ion-card>
            </div>

            <app-timetable-grid [sessions]="masterTimetableSessions" (sessionClick)="handleSessionClick($event)">
            </app-timetable-grid>
          </div>
        </div>
      </div>

      <!-- Calendar Configuration Section -->
      <div *ngIf="activeSection === 'calendar'" class="section-container">
        <h1>Academic Calendar Configuration</h1>
        
        <div class="calendar-config-content">
          <!-- Current Calendar Status Card -->
          <ion-card class="current-status-card">
            <ion-card-header>
              <ion-card-title>
                <ion-icon name="calendar-outline" slot="start"></ion-icon>
                Current Calendar Status
              </ion-card-title>
              <ion-card-subtitle>
                Overview of your active academic calendar configuration
              </ion-card-subtitle>
            </ion-card-header>
            
            <ion-card-content>
              <div class="status-grid">
                <div class="status-item">
                  <ion-icon name="school-outline" color="primary"></ion-icon>
                  <div class="status-details">
                    <h4>Academic Year</h4>
                    <p class="status-value">{{ getCurrentCalendarYear() }}</p>
                  </div>
                </div>
                
                <div class="status-item">
                  <ion-icon name="calendar-number-outline" color="success"></ion-icon>
                  <div class="status-details">
                    <h4>Active Weeks</h4>
                    <p class="status-value">{{ getActiveWeeksCount() }}</p>
                  </div>
                </div>
                
                <div class="status-item">
                  <ion-icon name="bookmarks-outline" color="warning"></ion-icon>
                  <div class="status-details">
                    <h4>Academic Periods</h4>
                    <p class="status-value">{{ getAcademicPeriodsCount() }}</p>
                  </div>
                </div>
                
                <div class="status-item">
                  <ion-icon name="document-text-outline" color="danger"></ion-icon>
                  <div class="status-details">
                    <h4>Exam Periods</h4>
                    <p class="status-value">{{ getExamPeriodsCount() }}</p>
                  </div>
                </div>
              </div>
              
              <div class="calendar-actions">
                <ion-button 
                  fill="outline" 
                  color="medium" 
                  (click)="exportCurrentCalendar()"
                  [disabled]="!hasActiveCalendar()">
                  <ion-icon name="download-outline" slot="start"></ion-icon>
                  Export Calendar
                </ion-button>
                
                <ion-button 
                  fill="clear" 
                  color="danger" 
                  (click)="resetCalendarConfig()"
                  [disabled]="!hasActiveCalendar()">
                  <ion-icon name="refresh-outline" slot="start"></ion-icon>
                  Reset to Default
                </ion-button>
              </div>
            </ion-card-content>
          </ion-card>

          <!-- Upload New Calendar Card -->
          <ion-card class="upload-card">
            <ion-card-header>
              <ion-card-title>
                <ion-icon name="cloud-upload-outline" slot="start"></ion-icon>
                Upload New Academic Calendar
              </ion-card-title>
              <ion-card-subtitle>
                Replace the current calendar configuration with a new institutional calendar
              </ion-card-subtitle>
            </ion-card-header>
            
            <ion-card-content>
              <div class="upload-controls">
                <ion-button 
                  expand="block" 
                  fill="solid" 
                  color="primary"
                  (click)="openCalendarUploadModal()"
                  class="upload-btn">
                  <ion-icon name="cloud-upload" slot="start"></ion-icon>
                  Upload Academic Calendar
                </ion-button>
                
                <p class="upload-description">
                  Click to open the calendar upload interface where you can:
                </p>
                <ul class="upload-features">
                  <li>Download templates in TXT, CSV, or JSON format</li>
                  <li>Upload your institutional calendar</li>
                  <li>Preview and validate calendar data</li>
                  <li>Configure academic year settings</li>
                </ul>
              </div>
            </ion-card-content>
          </ion-card>

          <!-- Calendar Management Tools -->
          <ion-card class="management-tools-card">
            <ion-card-header>
              <ion-card-title>
                <ion-icon name="settings-outline" slot="start"></ion-icon>
                Calendar Management Tools
              </ion-card-title>
              <ion-card-subtitle>
                Additional tools for managing your academic calendar
              </ion-card-subtitle>
            </ion-card-header>
            
            <ion-card-content>
              <div class="tools-grid">
                <ion-button 
                  fill="outline" 
                  expand="block"
                  (click)="viewCalendarDetails()"
                  [disabled]="!hasActiveCalendar()">
                  <ion-icon name="eye-outline" slot="start"></ion-icon>
                  View Calendar Details
                </ion-button>
                
                <ion-button 
                  fill="outline" 
                  expand="block"
                  (click)="validateCalendarData()"
                  [disabled]="!hasActiveCalendar()">
                  <ion-icon name="checkmark-circle-outline" slot="start"></ion-icon>
                  Validate Calendar Data
                </ion-button>
                
                <ion-button 
                  fill="outline" 
                  expand="block"
                  (click)="previewCalendarChanges()"
                  [disabled]="!hasActiveCalendar()">
                  <ion-icon name="preview-outline" slot="start"></ion-icon>
                  Preview Changes
                </ion-button>
                
                <ion-button 
                  fill="outline" 
                  expand="block"
                  (click)="generateCalendarReport()"
                  [disabled]="!hasActiveCalendar()">
                  <ion-icon name="document-outline" slot="start"></ion-icon>
                  Generate Report
                </ion-button>
              </div>
            </ion-card-content>
          </ion-card>
        </div>
      </div>

      <!-- User Management Section -->
      <div *ngIf="activeSection === 'users'" class="section-container">
        <h1>User Management</h1>

        <div class="filter-controls">
          <ion-searchbar placeholder="Search users"></ion-searchbar>
          <ion-select placeholder="Filter by department">
            <ion-select-option value="">All Departments</ion-select-option>
            <ion-select-option *ngFor="let dept of departments" [value]="dept.name">{{dept.name}}</ion-select-option>
          </ion-select>
          <ion-button (click)="showAddUserModal()">
            <ion-icon name="person-add" slot="start"></ion-icon>
            Add HOD
          </ion-button>
        </div>

        <ion-list class="user-list">
          <ion-item-group>
            <ion-item-divider>
              <ion-label>Heads of Department</ion-label>
            </ion-item-divider>
            <ion-item *ngFor="let user of users" button detail (click)="editUser(user)">
              <ion-avatar slot="start">
                <img [src]="user.avatar || 'assets/default-avatar.png'" alt="User Avatar">
              </ion-avatar>
              <ion-label>
                <h2>{{user.title}} {{user.name}}</h2>
                <p>{{user.contact?.email}}</p>
                <p>Department: {{user.department}}</p>
              </ion-label>
              <ion-badge slot="end" color="primary">{{user.role || 'HOD'}}</ion-badge>
            </ion-item>
            <ion-item *ngIf="users.length === 0">
              <ion-label color="medium">No HODs added yet</ion-label>
            </ion-item>
          </ion-item-group>
        </ion-list>

        <ion-card class="help-card">
          <ion-card-header>
            <ion-card-title>User Management Help</ion-card-title>
          </ion-card-header>
          <ion-card-content>
            <p>As an administrator, you can add Heads of Department (HODs) for each academic department.</p>
            <p>When you add a HOD, an authentication account will be automatically created using their email address with a secure default password.</p>
            <p>HODs will then be able to add lecturers to their departments, and lecturers can add students to their courses.</p>
          </ion-card-content>
        </ion-card>
      </div>

      <!-- Department Management Section -->
      <div *ngIf="activeSection === 'departments'" class="section-container">
        <h1>Department Management</h1>

        <div class="filter-controls">
          <ion-searchbar placeholder="Search departments"></ion-searchbar>
          <ion-button (click)="showAddDepartmentModal()">
            <ion-icon name="add-circle" slot="start"></ion-icon>
            Add Department
          </ion-button>
        </div>

        <ion-list class="department-list">
          <ion-item *ngFor="let department of departments" button detail>
            <ion-icon name="business" slot="start" [color]="department.status === 'active' ? 'primary' : 'medium'"></ion-icon>
            <ion-label>
              <h2>{{department.name}} ({{department.code}})</h2>
              <p>HOD: {{department.hodName || 'Not assigned'}}</p>
              <p>{{department.location}}</p>
              <p>Modules: {{department.moduleCount || 0}} | Status: 
                <ion-badge [color]="department.status === 'active' ? 'success' : 'warning'">
                  {{department.status | titlecase}}
                </ion-badge>
              </p>
            </ion-label>
            <div slot="end" class="department-actions">
              <ion-button fill="clear" size="small" (click)="editDepartment(department); $event.stopPropagation()">
                <ion-icon name="create" color="primary"></ion-icon>
              </ion-button>
              <ion-button fill="clear" size="small" (click)="deleteDepartment(department); $event.stopPropagation()">
                <ion-icon name="trash" color="danger"></ion-icon>
              </ion-button>
            </div>
          </ion-item>
        </ion-list>
      </div>

      <!-- Venue Management Section -->
      <div *ngIf="activeSection === 'venues'" class="section-container">
        <h1>Venue Management</h1>

        <ion-segment [(ngModel)]="venueManagementView" (ionChange)="venueManagementViewChanged()">
          <ion-segment-button value="list">
            <ion-icon name="list-outline"></ion-icon>
            <ion-label>Venues</ion-label>
          </ion-segment-button>
          <ion-segment-button value="availability">
            <ion-icon name="calendar-outline"></ion-icon>
            <ion-label>Venue Availability</ion-label>
          </ion-segment-button>
          <ion-segment-button value="conflicts">
            <ion-icon name="alert-circle-outline"></ion-icon>
            <ion-label>Venue Conflicts</ion-label>
          </ion-segment-button>
          <ion-segment-button value="requests">
            <ion-icon name="calendar-number-outline"></ion-icon>
            <ion-label>Special Requests</ion-label>
          </ion-segment-button>
        </ion-segment>

        <!-- Venue List View -->
        <div *ngIf="venueManagementView === 'list'">
          <div class="filter-controls">
            <ion-searchbar placeholder="Search venues" [(ngModel)]="venueSearchTerm"></ion-searchbar>
            <ion-select placeholder="Filter by type" [(ngModel)]="venueTypeFilter">
              <ion-select-option value="">All Types</ion-select-option>
              <ion-select-option value="classroom">Classroom</ion-select-option>
              <ion-select-option value="lab">Laboratory</ion-select-option>
              <ion-select-option value="lecture">Lecture Hall</ion-select-option>
            </ion-select>
            <ion-button (click)="showAddVenueModal()">
              <ion-icon name="add-circle" slot="start"></ion-icon>
              Add Venue
            </ion-button>
          </div>

          <ion-list class="venue-list">
            <ion-item *ngFor="let venue of getFilteredVenuesList()" button detail (click)="editVenue(venue)">
              <ion-icon name="business" slot="start"></ion-icon>
              <ion-label>
                <h2>{{venue.name}}</h2>
                <p>Type: {{venue.type}} | Capacity: {{venue.capacity}}</p>
                <p>Equipment: {{venue.equipment.join(', ')}}</p>
              </ion-label>
            </ion-item>
          </ion-list>
        </div>

        <!-- Venue Availability View -->
        <div *ngIf="venueManagementView === 'availability'" class="venue-availability-wrapper">
          <app-venue-avail 
            [venues]="venues" 
            (bookVenue)="handleVenueBookingRequest($event)">
          </app-venue-avail>
        </div>

        <!-- Venue Conflicts View -->
        <div *ngIf="venueManagementView === 'conflicts'" class="venue-conflicts-wrapper">
          <div *ngIf="venueConflicts.length > 0" class="conflicts-summary">
            <ion-card color="danger">
              <ion-card-header>
                <ion-card-title>{{venueConflicts.length}} Venue Conflicts Found</ion-card-title>
                <ion-card-subtitle>These conflicts need to be resolved</ion-card-subtitle>
              </ion-card-header>
              <ion-card-content>
                <ion-list>
                  <ion-item *ngFor="let conflict of venueConflicts" button (click)="highlightVenueConflict(conflict)">
                    <ion-icon name="alert-circle" slot="start" color="danger"></ion-icon>
                    <ion-label>
                      <h2>{{conflict.venue.name}} ({{conflict.date | date:'mediumDate'}})</h2>
                      <p>Conflicting bookings: {{conflict.sessions.length}}</p>
                    </ion-label>
                    <ion-button slot="end" fill="clear" (click)="resolveVenueConflict(conflict)">
                      Resolve
                    </ion-button>
                  </ion-item>
                </ion-list>
              </ion-card-content>
            </ion-card>
          </div>

          <div *ngIf="venueConflicts.length === 0" class="placeholder-content success-content">
            <ion-icon name="checkmark-circle" color="success" style="font-size: 48px;"></ion-icon>
            <p>No venue conflicts detected</p>
          </div>

          <div *ngIf="selectedConflict" class="selected-conflict-details">
            <h3>Conflict Details: {{selectedConflict.venue.name}}</h3>
            <app-venue-avail [venues]="[selectedConflict.venue]" (bookVenue)="handleVenueBookingRequest($event)">
            </app-venue-avail>
          </div>
        </div>

        <!-- Special Event Requests View -->
        <div *ngIf="venueManagementView === 'requests'" class="venue-requests-wrapper">
          <div class="requests-list">
            <ion-list>
              <ion-item-divider>
                <ion-label>Pending Special Event Requests</ion-label>
              </ion-item-divider>
              <ion-item *ngFor="let request of specialEventRequests" button detail
                (click)="viewSpecialEventRequest(request)">
                <ion-icon name="calendar" slot="start"
                  [color]="request.status === 'pending' ? 'warning' : 'success'"></ion-icon>
                <ion-label>
                  <h2>{{request.title}}</h2>
                  <p>{{request.venue.name}} | {{request.date | date:'medium'}} | {{request.duration}} hours</p>
                  <p>Requested by: {{request.requester}}</p>
                </ion-label>
                <ion-badge slot="end"
                  [color]="request.status === 'pending' ? 'warning' : 'success'">{{request.status}}</ion-badge>
              </ion-item>
              <ion-item *ngIf="specialEventRequests.length === 0">
                <ion-label color="medium">No pending special event requests</ion-label>
              </ion-item>
            </ion-list>
          </div>

          <div *ngIf="selectedSpecialRequest" class="selected-request-details">
            <ion-card>
              <ion-card-header>
                <ion-card-title>{{selectedSpecialRequest.title}}</ion-card-title>
                <ion-card-subtitle>Special Event Request</ion-card-subtitle>
              </ion-card-header>
              <ion-card-content>
                <ion-item>
                  <ion-label>Venue:</ion-label>
                  <ion-text>{{selectedSpecialRequest.venue.name}}</ion-text>
                </ion-item>
                <ion-item>
                  <ion-label>Date & Time:</ion-label>
                  <ion-text>{{selectedSpecialRequest.date | date:'medium'}}</ion-text>
                </ion-item>
                <ion-item>
                  <ion-label>Duration:</ion-label>
                  <ion-text>{{selectedSpecialRequest.duration}} hours</ion-text>
                </ion-item>
                <ion-item>
                  <ion-label>Requester:</ion-label>
                  <ion-text>{{selectedSpecialRequest.requester}}</ion-text>
                </ion-item>
                <ion-item>
                  <ion-label>Purpose:</ion-label>
                  <ion-text>{{selectedSpecialRequest.purpose}}</ion-text>
                </ion-item>

                <div class="request-actions">
                  <ion-button color="success" expand="block" (click)="approveSpecialRequest(selectedSpecialRequest)"
                    *ngIf="selectedSpecialRequest.status === 'pending'">
                    <ion-icon name="checkmark-circle" slot="start"></ion-icon>
                    Approve Request
                  </ion-button>
                  <ion-button color="danger" expand="block" (click)="rejectSpecialRequest(selectedSpecialRequest)"
                    *ngIf="selectedSpecialRequest.status === 'pending'">
                    <ion-icon name="close-circle" slot="start"></ion-icon>
                    Reject Request
                  </ion-button>
                </div>
              </ion-card-content>
            </ion-card>

            <div class="venue-availability-check">
              <h4>Venue Availability Check</h4>
              <app-venue-avail [venues]="[selectedSpecialRequest.venue]"
                (bookVenue)="handleVenueBookingRequest($event)">
              </app-venue-avail>
            </div>
          </div>
        </div>
      </div>

      <!-- Reports Section -->
      <div *ngIf="activeSection === 'reports'" class="section-container">
        <h1>System Reports</h1>

        <!-- Replace with the app-reports component -->
        <app-reports></app-reports>
      </div>

      <!-- Settings Section -->
      <div *ngIf="activeSection === 'settings'" class="section-container">
        <h1>System Settings</h1>

        <ion-list>
          <ion-item-group>
            <ion-item-divider>
              <ion-label>Academic Year Configuration</ion-label>
            </ion-item-divider>
            <ion-item>
              <ion-label>Current Academic Year</ion-label>
              <ion-select placeholder="Select Year">
                <ion-select-option value="2023-2024">2023-2024</ion-select-option>
                <ion-select-option value="2024-2025">2024-2025</ion-select-option>
              </ion-select>
            </ion-item>
            <ion-item>
              <ion-label>Current Semester</ion-label>
              <ion-select placeholder="Select Semester">
                <ion-select-option value="1">Semester 1</ion-select-option>
                <ion-select-option value="2">Semester 2</ion-select-option>
              </ion-select>
            </ion-item>
          </ion-item-group>

          <ion-item-group>
            <ion-item-divider>
              <ion-label>Timetable Configuration</ion-label>
            </ion-item-divider>
            <ion-item>
              <ion-label>Starting Time</ion-label>
              <ion-datetime displayFormat="HH:mm" placeholder="Select Time"></ion-datetime>
            </ion-item>
            <ion-item>
              <ion-label>Ending Time</ion-label>
              <ion-datetime displayFormat="HH:mm" placeholder="Select Time"></ion-datetime>
            </ion-item>
            <ion-item>
              <ion-label>Time Slot Duration (minutes)</ion-label>
              <ion-select placeholder="Select Duration">
                <ion-select-option value="30">30 minutes</ion-select-option>
                <ion-select-option value="60">60 minutes</ion-select-option>
                <ion-select-option value="90">90 minutes</ion-select-option>
              </ion-select>
            </ion-item>
          </ion-item-group>

          <ion-item-group>
            <ion-item-divider>
              <ion-label>Email Notifications</ion-label>
            </ion-item-divider>
            <ion-item>
              <ion-label>Timetable Publication</ion-label>
              <ion-toggle></ion-toggle>
            </ion-item>
            <ion-item>
              <ion-label>Conflict Detection</ion-label>
              <ion-toggle></ion-toggle>
            </ion-item>
            <ion-item>
              <ion-label>User Registration</ion-label>
              <ion-toggle></ion-toggle>
            </ion-item>
          </ion-item-group>
        </ion-list>

        <div class="settings-actions">
          <ion-button expand="block" color="primary" (click)="saveSettings()">
            Save Settings
          </ion-button>
        </div>
      </div>

      <!-- Backup & Restore Section -->
      <div *ngIf="activeSection === 'backup'" class="section-container">
        <h1>Backup & Restore</h1>

        <div class="backup-actions">
          <ion-button expand="block" (click)="createBackup()">
            <ion-icon name="save" slot="start"></ion-icon>
            Create New Backup
          </ion-button>
        </div>

        <h3>Backup History</h3>
        <ion-list class="backup-list">
          <ion-item *ngFor="let backup of backups">
            <ion-icon name="archive" slot="start"></ion-icon>
            <ion-label>
              <h2>{{backup.name}}</h2>
              <p>Created: {{backup.created | date:'medium'}}</p>
              <p>Size: {{backup.size}}</p>
            </ion-label>
            <ion-button fill="clear" (click)="restoreBackup(backup)">
              <ion-icon name="refresh"></ion-icon>
              Restore
            </ion-button>
            <ion-button fill="clear" (click)="downloadBackup(backup)">
              <ion-icon name="download"></ion-icon>
              Download
            </ion-button>
          </ion-item>
        </ion-list>

        <h3>Scheduled Backups</h3>
        <ion-list>
          <ion-item>
            <ion-label>Enable Scheduled Backups</ion-label>
            <ion-toggle [(ngModel)]="scheduledBackupsEnabled"></ion-toggle>
          </ion-item>
          <ion-item>
            <ion-label>Frequency</ion-label>
            <ion-select placeholder="Select Frequency" [disabled]="!scheduledBackupsEnabled">
              <ion-select-option value="daily">Daily</ion-select-option>
              <ion-select-option value="weekly">Weekly</ion-select-option>
              <ion-select-option value="monthly">Monthly</ion-select-option>
            </ion-select>
          </ion-item>
          <ion-item>
            <ion-label>Time</ion-label>
            <ion-datetime displayFormat="HH:mm" placeholder="Select Time"
              [disabled]="!scheduledBackupsEnabled"></ion-datetime>
          </ion-item>
        </ion-list>

        <div class="backup-actions">
          <ion-button expand="block" color="primary" (click)="saveBackupSettings()">
            Save Backup Settings
          </ion-button>
        </div>
      </div>
    </div>
  </div>
</ion-content>